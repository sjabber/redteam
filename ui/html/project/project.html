<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#FFFFFF">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" name="viewport">
    <title>REDTEAM | 프로젝트 관리</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito|Roboto">
    <link rel="stylesheet" href="https://maxcdn.icons8.com/fonts/line-awesome/1.1/css/line-awesome.min.css">
    <link rel="stylesheet" href="/css/sport.min.css" type="text/css">
    <link rel="stylesheet" href="/css/choices.min.css" type="text/css">
    <!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.2.1/css/bootstrap-grid.css">-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
    <script src="https://cdn.ckeditor.com/4.15.1/standard/ckeditor.js"></script>
    <link rel="stylesheet" href="/css/datepicker.min.css">
    <script src="/js/jquery-3.1.1.min.js"></script>
    <script src="/js/datepicker.js"></script>
    <script src="/js/datepicker.ko.js"></script>
</head>
<body>
<!--네이게이터-->
<div class="sidebar">
    <div class="sidebar-header"><a href="#">
        <img src="/image/intro_icon.png" style="max-width: 80%; height: auto;">
    </a>
        <div class="sidebar-control"><i class="la la-navicon"></i></div>
    </div>
    <div class="sidebar-wrapper">
        <ul class="list-menu">
            <li class="header">Total Info</li>

            <li class="tree-item"><a href="/dashboard/total"><i class="la la-group"></i><span>대시보드</span>
                <div class="right-container"></div>
            </a>

            <li class="header">Project Info</li>
            <li class="tree-item active"><a href="/project/progress"><i class="la la-group"></i><span>프로젝트 관리</span>
                <div class="right-container"></div>
            </a>

            </li>
            <li class="tree-item"><a href="/manager/target"><i class="la la-group"></i><span>대상관리</span>
                <div class="right-container"></div>
            </a>

            </li>
            <li class="tree-item"><a href="/manager/template"><i class="la la-file-text"></i><span>템플릿관리</span>
                <div class="right-container"></div>
            </a>
            </li>
            <li class="header">Setting</li>
            <li class="has-children"><a href="javascript:"><i class="la la-cog"></i><span>설정</span>
                <div class="right-container"><i class="la la-chevron-right tree-icon"></i></div>
            </a>
                <ul class="tree">
                    <li class="tree-item"><a href="/setting/user"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">사용자 정보</span></a></li>
                    <li class="tree-item"><a href="/setting/smtp"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">SMTP 설정</span></a></li>
                </ul>
            </li>
            </li>
            <li class="header">Help</li>
            <li class="has-children"><a href="javascript:"><i class="la la-question"></i><span>도움말</span>
                <div class="right-container"><i class="la la-chevron-right tree-icon"></i></div>
            </a>
                <ul class="tree">
                    <li class="tree-item"><a href="/help/project"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">프로젝트 관리</span></a></li>
                    <li class="tree-item"><a href="/help/target"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">대상 관리</span></a></li>
                    <li class="tree-item"><a href="/help/template"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">템플릿 관리</span></a></li>
                    <li class="tree-item"><a href="/help/smtp"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">SMTP 설정</span></a></li>
                </ul>
            </li>
        </ul>
    </div>
</div>
<!--네이게이터-->


<div class="main-content">
    <div class="header">
        <div class="left">
            <p></p>
            <div class="breadcrumb"><span>프로젝트 관리</span></div>
        </div>
        <ul class="right">
            <li class="header-user dropdown ml-4 mr-3"><a class="user-photo trigger-dropdown"><img class="user-img"
                                                                                                   src="/image/user.png"/></a>
                <div class="dropdown-box with-header">
                    <div class="dropdown-header"><img class="user-img user-img--lg"
                                                      src="/image/user.png"/>
                        <div class="user-info">
                            <h3 id="dropdown_name">name</h3><span class="helper-text" id="dropdown_id">email</span>
                        </div>
                    </div>
                    <ul class="dropdown-body">
                        <li><a href="/setting/user" target="_blank"><i
                                class="la la-user"></i><span>사용자 정보</span></a></li>
                        <li><a href="/setting/smtp"><i class="la la-cogs"></i><span>SMTP 설정</span></a></li>
                        <li><a href="javascript:Logout();"><i class="la la-power-off"></i><span>로그아웃</span></a></li>
                    </ul>
                </div>
            </li>
        </ul>
        <div class="right--mobile"><a class="header-item--mobile sidebar-control"><i class="la la-navicon"></i></a><a
                class="header-item--mobile"><i class="la la-comments"></i></a><a class="header-item--mobile"><i
                class="la la-ellipsis-v"></i></a></div>
    </div>

    <div class="content-wrapper">
        <div class="row">
            <div class="col-12">
                <div class="box">
                    <div class="box-header">
                        <h3>프로젝트 관리</h3>
                        <div class="toolbox" style="justify-content: center">
                            <div class="btn-group" style="margin-left: 10px;">

                                <button class="btn btn-primary active" id="reg_project"
                                        onclick="OpenProjectCreateModal()"><span>프로젝트 등록</span></button>
                                <button class="btn btn-primary" id="del_project"><span>프로젝트 삭제</span></button>
                            </div>
                        </div>
                    </div>

                    <div class="pgn-modal" id="tml_viewer">
                        <div class="pgn-modal-wrapper ">
                            <div class="modal__header">
                                <h5>템플릿 수정</h5>
                                <div class="toolbox">
                                    <button class="btn-modal-close modal-dismiss" onclick="closeModal()"><i
                                            class="la la-times"></i></button>
                                </div>
                            </div>
                            <div class="modal__body">
                                <div class="form-group w-50">
                                    <label for="tmp_division">구분</label><select disabled id="tmp_division">
                                    <option value="1" selected>기본</option>
                                    <option value="2">사용자</option>
                                </select>
                                </div>

                                <div class="form-group w-50">
                                    <label for="tmp_kind">훈련유형</label><select disabled id="tmp_kind">
                                    <option value="1" selected>경고 안내</option>
                                    <option value="2">피싱 유도</option>
                                    <option value="3">실태 조사</option>
                                </select>
                                </div>

                                <div class="form-group w-50">
                                    <label for="file_info">첨부파일 정보</label><select disabled id="file_info">
                                    <option selected value="">첨부파일 없음</option>
                                    <option value="1">EXE</option>
                                    <option value="2">HTML</option>
                                    <option value="3">Excel</option>
                                </select>
                                </div>

                                <div class="form-group">
                                    <label for="tmp_name">템플릿명</label>
                                    <input disabled type="text"
                                           id="tmp_name"
                                           maxlength="30">
                                    <input type="hidden" id="tmp_no">
                                </div>

                                <div class="form-group">
                                    <label for="sender_name">발송자명</label>
                                    <input disabled type="text"
                                           id="sender_name"
                                           maxlength="30">
                                </div>
                                <!-- <label>발송자</label> -->

                                <div class="form-group">
                                    <label for="title">메일 제목</label>
                                    <input disabled type="text"
                                           id="title" maxlength="60"></div>
                                <!-- <label>메일 제목(최대 30자)</label> -->


                                <textarea name="content" id="content"></textarea>
                                <script>
                                    CKEDITOR.replace('content');
                                </script>
                                <div class="form-group">
                                    <div style="color: red;font-weight: bold; font-size: small">
                                        {{target_name}} : 훈련 대상자의 이름, {{count_ip}} : 악성메일 훈련 솔루션 IP, {{target_position}}
                                        : 직급, {{target_orgarnize}} : 조직, {{target_phone}} : 훈련 대상자의 전화번호
                                    </div>
                                </div>
                                <div class="form-group w-50">
                                    <label for="download_type">다운로드 방식</label><select disabled id="download_type">
                                    <option selected value="1">첨부파일 없음</option>
                                    <option value="2">링크 첨부</option>
                                    <option value="3">파일 첨부</option>
                                </select>
                                </div>

                            </div>
                            <div class="modal__footer">
                                <button class="btn btn-primary" onclick="closeModal()">닫기</button>

                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="pgn-modal" id="project_regist">
                        <div class="pgn-modal-wrapper">
                            <div class="modal__header">
                                <h5>프로젝트 등록</h5>
                                <div class="toolbox">
                                    <button class="btn-modal-close" onclick="CloseProjectCreateModal()"><i
                                            class="la la-times"></i></button>
                                </div>
                            </div>
                            <div class="modal__body">
                                <div class="form-group">
                                    <label>프로젝트 이름</label>
                                    <input type="text" id="p_name">
                                </div>
                                <div class="form-group">
                                    <textarea type="text" id="p_description" placeholder="프로젝트 설명" cols="50"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="start_dates">프로젝트 시작일</label>
                                    <input type="text" id="start_dates" name="start_dates" readonly size="12">
                                    <!--                                    <input id="start_date" type="date" value="xxx" min="yyy" max="zzz">-->
                                </div>
                                <div class="form-group">
                                    <label for="end_dates">프로젝트 종료일</label>
                                    <input type="text" id="end_dates" name="end_dates" readonly size="12">
                                    <!--                                    <input id="end_date" type="date" value="xxx" min="yyy" max="zzz">-->
                                </div>
                                <script>
                                    $('#end_dates').datepicker({
                                        minDate: new Date(),
                                    })

                                    datePickerSet($("#start_dates"), $("#end_dates"), true);

                                    function datePickerSet(sDate, eDate, flag) {

                                        //시작 ~ 종료 2개 짜리 달력 datepicker
                                        if (!isValidStr(sDate) && !isValidStr(eDate) && sDate.length > 0 && eDate.length > 0) {
                                            var sDay = sDate.val();
                                            var eDay = eDate.val();

                                            if (flag && !isValidStr(sDay) && !isValidStr(eDay)) { //처음 입력 날짜 설정, update...
                                                var sdp = sDate.datepicker().data("datepicker");
                                                sdp.selectDate(new Date(sDay.replace(/-/g, "/")));  //익스에서는 그냥 new Date하면 -을 인식못함 replace필요

                                                var edp = eDate.datepicker().data("datepicker");
                                                edp.selectDate(new Date(eDay.replace(/-/g, "/")));  //익스에서는 그냥 new Date하면 -을 인식못함 replace필요
                                            }

                                            if (!isValidStr(eDay)) {
                                                //isValidStr -> true, 값이 없는것 -> false 처리됨
                                                //isValidStr -> false, 값이 있음 -> true 처리됨

                                                eDay = new Date(eDay);

                                                // 종료일을 먼저 고른경우 시작일은 종료일 하루 전까지만 가능하도록
                                                eDay.setDate(eDay.getDate() - 1);
                                                let dd = eDay.getDate();

                                                let mm = eDay.getMonth();
                                                mm += 1;

                                                let yy = eDay.getFullYear();


                                                const FormattedDate = yy + '-' + mm + '-' + dd;
                                                console.log(FormattedDate);

                                                sDate.datepicker({
                                                    maxDate: new Date(FormattedDate)
                                                    //maxDate: new Date(eDay.replace(/-/g, "/")),
                                                });
                                            }
                                            //시작일자 세팅하기 날짜가 없는경우엔 제한을 걸지 않음
                                            sDate.datepicker({
                                                language: 'ko',
                                                autoClose: true,
                                                minDate: new Date(),
                                                onSelect: function () {
                                                    datePickerSet(sDate, eDate);
                                                }
                                            });


                                            if (!isValidStr(sDay)) {
                                                //isValidStr -> true, 값이 없는것 -> false 처리됨
                                                //isValidStr -> false, 값이 있음 -> true 처리됨

                                                sDay = new Date(sDay);

                                                // 시작일을 먼저 고른경우 종료일은 시작일 하루 뒤뒤부터 가능하도록
                                                sDay.setDate(sDay.getDate() + 1);
                                                let dd = sDay.getDate();

                                                let mm = sDay.getMonth();
                                                mm += 1;

                                                let yy = sDay.getFullYear();


                                                const FormattedDate2 = yy + '-' + mm + '-' + dd;
                                                console.log(FormattedDate2);

                                                eDate.datepicker({
                                                    minDate: new Date(FormattedDate2)
                                                    // minDate: new Date(sDay.replace(/-/g, "/"))
                                                });
                                            }
                                            //종료일자 세팅하기 날짜가 없는경우엔 제한을 걸지 않음
                                            eDate.datepicker({
                                                language: 'ko',
                                                autoClose: true,
                                                onSelect: function () {
                                                    datePickerSet(sDate, eDate);
                                                }
                                            });
                                        }

                                        function isValidStr(str) {
                                            if (str === null || str === undefined || str === "")
                                                return true;
                                            else
                                                return false;
                                        }

                                    }
                                </script>
                                <div class="form-group">
                                    <label for="template">템플릿 선택</label>
                                    <select id="template"></select>
                                </div>
                                <div class="form-group w-50">
                                    <label for="tag_1">훈련 대상자 선택(태그) 1(최대 3)</label><select id="tag_1">
                                </select>
                                </div>
                                <div class="form-group w-50">
                                    <label for="tag_2">훈련 대상자 선택(태그) 2(최대 3)</label><select id="tag_2">
                                </select>
                                </div>
                                <div class="form-group w-50">
                                    <label for="tag_3">훈련 대상자 선택(태그) 3(최대 3)</label><select id="tag_3">
                                </select>
                                </div>
                            </div>
                            <div class="modal__footer">
                                <button class="btn btn-secondary btn-lg btn-block w-50" onclick="SmtpSimpleTest()">SMTP
                                    연결 테스트
                                </button>
                                <div class="modal__footer">
                                    <button class="btn btn-ghost" onclick="CloseProjectCreateModal()">취소</button>
                                    <button class="btn btn-primary pull-right" id="project_reg"
                                            onclick="CreateProject()">
                                        등록
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="toolbox">
                        <div class="box-body pt-0 px-0 responsive">
                            <table id="project_list">
                                <thead>
                                <tr>
                                    <th style="visibility:hidden;position:absolute;"></th>
                                    <th>
                                        <div class="pgn-checkbox"><input type="checkbox" id="all_select"><span></span>
                                        </div>
                                    </th>
                                    <th>No</th>
                                    <th>프로젝트명</th>
                                    <th>대상 태그</th>
                                    <th>진행상태</th>
                                    <th>템플릿명</th>
                                    <th>대상자 수</th>
                                    <th>메일 전송 현황(%)</th>
                                    <th>메일 열람 현황(%)</th>
                                    <th>Link 접속 현황(%)</th>
                                    <th>File 실행 현황(%)</th>
                                    <th>시작일</th>
                                    <th>종료일</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="pagination-wrapper clearfix" id="under">
                        <ul class="pagination float--right" id="pages">
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="/js/lib/Sortable.min.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="/js/jquery.serialize-object.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/demo.js"></script>
<script src="/js/script.js"></script>
<script>
    // 계정별 태그정보 (최대 5개)
    var tg_total = [5];

    function GetTag() {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://localhost:5000/setting/getTag', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let rObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    rObj = JSON.parse(r.responseText);
                    if (rObj.tags.length > 0) {


                        $('#tag_1').empty();
                        $('#tag_2').empty();
                        $('#tag_3').empty();
                        // No, id, 구분, 훈련유형, 첨부파일 정보, 템플릿명, 메일 제목, 발송자명, 다운로드 유형, 등록일
                        // No ,tmp_no , division, kind, file_info, tmp_name, mail_title, sender_name, download_type, created_t
                        $('#tag_1').append("<option value=''>훈련 대상 태그 선택하기</option>");
                        $('#tag_2').append("<option value=''>훈련 대상 태그 선택하기</option>");
                        $('#tag_3').append("<option value=''>훈련 대상 태그 선택하기</option>");
                        for (let i = 0; i < rObj.tags.length; i++) {
                            // <label className="badge badge-red">엘지전자</label>
                            // <label className="badge badge-blue">레드팀</label>
                            $('#tag_1').append("<option value='" + rObj.tags[i].tag_no + "'>" + rObj.tags[i].tag_name + "</option>");
                            $('#tag_2').append("<option value='" + rObj.tags[i].tag_no + "'>" + rObj.tags[i].tag_name + "</option>");
                            $('#tag_3').append("<option value='" + rObj.tags[i].tag_no + "'>" + rObj.tags[i].tag_name + "</option>");
                        }
                    } else {
                        $('#tag').append("<option value=''>등록된 대상자가 없습니다.</option>");
                    }
                } else if (r.status === 403) {
                    Refresh();
                    GetTag();
                } else {
                    document.location.href = '/';
                }
            }
        };
        r.send();
    }

    function GetTmpl() {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://localhost:5000/setting/getTemplates', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let rObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    rObj = JSON.parse(r.responseText);
                    if (rObj.tmpls.length > 0) {
                        $('#template').empty();
                        // No, id, 구분, 훈련유형, 첨부파일 정보, 템플릿명, 메일 제목, 발송자명, 다운로드 유형, 등록일
                        // No ,tmp_no , division, kind, file_info, tmp_name, mail_title, sender_name, download_type, created_t
                        $('#template').append("<option value=''>훈련 템플릿 선택하기</option>");
                        for (let i = 0; i < rObj.tmpls.length; i++) {
                            $('#template').append("<option value='" + rObj.tmpls[i].tmp_no + "'>" + rObj.tmpls[i].tmp_name + "</option>");
                        }
                    } else {
                        $('#template').append("<option value=''>등록된 템플릿이 없습니다.</option>");
                    }
                } else if (r.status === 403) {
                    Refresh();
                    GetTmpl();
                } else {
                    document.location.href = '/';
                }
            }
        };
        r.send();
    }

    function GetProject() {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://localhost:5000/api/getProject', false);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let rObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    rObj = JSON.parse(r.responseText);
                    console.log(r.responseText);

                    // let date = new Date();
                    // let today = date.getFullYear() + '-' + date.getMonth() + 1 + '-' + date.getDate();

                    if (rObj.project_list != null) {
                        // table 비워주기
                        $('#project_list > tbody').empty();
                        // No, 프로젝트명, 대상 태그, 진행상태, 템플릿명, 대상자 수, 감염 현황(%), 프로젝트 종료, 시작일, 종료일
                        // No, p_name, tag_name, p_status, p_name, targets, send_no, end_date, start_date
                        for (let i = 0; i < rObj.project_list.length; i++) {
                            // 태그 분리작업
                            let full_tag = ''
                            let status = ''

                            let send_percentage;
                            let reading_percentage;
                            let connect_percentage;
                            let infection_percentage;

                            for (let j = 0; j < rObj.project_list[i].tag_no.length; j++) {
                                // console.log(rObj.project_list
                                if (rObj.project_list[i].tag_no[j] !== "") {
                                    if (tg_total[0] === rObj.project_list[i].tag_no[j]) {
                                        full_tag += '<label id="label1">' + rObj.project_list[i].tag_no[j] + '</label>'
                                    } else if (tg_total[1] === rObj.project_list[i].tag_no[j]) {
                                        full_tag += '<label id="label2">' + rObj.project_list[i].tag_no[j] + '</label>'
                                    } else if (tg_total[2] === rObj.project_list[i].tag_no[j]) {
                                        full_tag += '<label id="label3">' + rObj.project_list[i].tag_no[j] + '</label>'
                                    } else if (tg_total[3] === rObj.project_list[i].tag_no[j]) {
                                        full_tag += '<label id="label4">' + rObj.project_list[i].tag_no[j] + '</label>'
                                    } else if (tg_total[4] === rObj.project_list[i].tag_no[j]) {
                                        full_tag += '<label id="label5">' + rObj.project_list[i].tag_no[j] + '</label>'
                                    }
                                }
                            }
                            // 프로젝트 진행 상황에 따라 버튼들의 색들을 다 다르게한다.
                            // if (rObj.project_list[i].p_status === "0") {
                            //   rObj.project_list[i].p_status = "예약"
                            //   status += '<button class="btn" style="color: white; padding: 4px 7px; background: #FFD764;' +
                            //           ' border: 2px solid transparent; border-radius: 3px;" ' +
                            //           'onclick="ProjectStart(' + rObj.project_list[i].p_no + ')">'
                            //           + rObj.project_list[i].p_status + '</button>'
                            //   end += '<button class="btn btn-c-success" id="project_end" ' +
                            //           'onclick="ProjectEnd(' + rObj.project_list[i].p_no + ')">프로젝트 종료하기</button>'
                            // } else if (rObj.project_list[i].p_status == "1") {
                            //   rObj.project_list[i].p_status = "진행";
                            //   status += '<button class="btn" style="color: white; padding: 4px 7px; background: #00A6A0;' +
                            //           ' border: 2px solid transparent; border-radius: 3px;">'
                            //           + rObj.project_list[i].p_status + '</button>'
                            //   end += '<button class="btn btn-c-success" id="project_end" ' +
                            //           'onclick="ProjectEnd(' + rObj.project_list[i].p_no + ')">프로젝트 종료하기</button>'
                            // } else if (rObj.project_list[i].p_status == "2") {
                            //   rObj.project_list[i].p_status = "종료";
                            //   status += '<button class="btn btn-primary">' + rObj.project_list[i].p_status + '</button>'
                            //   end += '<button class="btn btn-disabled" id="project_end" disabled="disabled" ' +
                            //           'onclick="ProjectEnd(' + rObj.project_list[i].p_no + ')">프로젝트 종료하기</button>'
                            // }

                            // 날짜와 프로젝트 상태를 같이 비교해 현재 프로젝트의 상태를 보여준다.
                            //today < rObj.project_list[i].start_date &&
                            if (rObj.project_list[i].p_status === "0") {
                                rObj.project_list[i].p_status = "예약";
                                status += '<button class="btn" style="color: white; padding: 4px 7px; background: #FFD764;' +
                                    ' border: 2px solid transparent; border-radius: 3px;" ' +
                                    'onclick="ProjectStart(' + rObj.project_list[i].p_no + ')">'
                                    + rObj.project_list[i].p_status + '</button>'

                                //rObj.project_list[i].start_date <= today && today < rObj.project_list[i].end_date &&
                            } else if (rObj.project_list[i].p_status === "1") {
                                rObj.project_list[i].p_status = "진행";
                                status += '<button class="btn" style="color: white; padding: 4px 7px; background: #00A6A0;' +
                                    ' border: 2px solid transparent; border-radius: 3px;">'
                                    + rObj.project_list[i].p_status + '</button>'

                                //rObj.project_list[i].end_date <= today &&
                            } else if (rObj.project_list[i].p_status === "2") {
                                rObj.project_list[i].p_status = "종료";
                                status += '<button class="btn btn-primary">' + rObj.project_list[i].p_status + '</button>'
                            } else if (rObj.project_list[i].p_status === "3") {
                                rObj.project_list[i].p_status = "오류";
                                status += '<button class="btn" style="color: white; padding: 4px 7px; background: #c65de3;' +
                                    ' border: 2px solid transparent; border-radius: 3px;">'
                                    + rObj.project_list[i].p_status + '</button>'
                            }

                            // 소수점은 화면에 안보여주기 위해 int 형으로 형변환한다.
                            // 전송비율
                            send_percentage = (rObj.project_list[i].send_no / rObj.project_list[i].targets) * 100;
                            send_percentage = parseInt(send_percentage);

                            // 열람비율
                            reading_percentage = (rObj.project_list[i].reading / rObj.project_list[i].targets) * 100;
                            reading_percentage = parseInt(reading_percentage);

                            // 열람비율
                            connect_percentage = (rObj.project_list[i].connect / rObj.project_list[i].targets) * 100;
                            connect_percentage = parseInt(connect_percentage);

                            // 감염비율
                            infection_percentage = (rObj.project_list[i].infection / rObj.project_list[i].targets) * 100;
                            infection_percentage = parseInt(infection_percentage);


                            if (full_tag === '') {// 태그가 없는경우 (존재해서는 안되는 case)
                                return
                            } else {
                                $('#project_list > tbody:last').append('<tr>' + '<td id=' + rObj.project_list[i].p_no
                                    + '" style="visibility:hidden;position:absolute;">' + rObj.project_list[i].p_no + '</td>'
                                    + '<td><div class="pgn-checkbox">'
                                    + '<input type="checkbox" name=""><span></span></div></td><td>' + rObj.project_list[i].fake_no + '</td>'
                                    + '<td>' + rObj.project_list[i].p_name + '</td><td>' + full_tag + '</td>'
                                    + '<td>' + status + '</td><td><button onclick="OpenModal(' + rObj.project_list[i].tml_no + "," + rObj.project_list[i].p_no + ')" class="btn btn-primary">' + rObj.project_list[i].tmp_no + '</buttom></td>'
                                    + '<td>' + rObj.project_list[i].targets + ' 명</td>' // 전체 대상자수
                                    + '<td><progress class="valign-middle" value="' + rObj.project_list[i].send_no + '" max="'
                                    + rObj.project_list[i].targets + '"></progress>' + send_percentage
                                    + "%(" + rObj.project_list[i].send_no + "명)" + '</td>' // 전송 현황
                                    + '<td><progress class="valign-middle" value="' + rObj.project_list[i].reading + '" max="'
                                    + rObj.project_list[i].targets + '"></progress>' + reading_percentage
                                    + "%(" + rObj.project_list[i].reading + "명)" + '</td>' // 열람 현황 (메일 읽은 사람 수)
                                    + '<td><progress class="valign-middle" value="' + rObj.project_list[i].connect + '" max="'
                                    + rObj.project_list[i].targets + '"></progress>' + connect_percentage
                                    + "%(" + rObj.project_list[i].connect + "명)" + '</td>' // 접속 현황 (위험 사이트 접속한 사람 수)
                                    + '<td><progress class="valign-middle" value="' + rObj.project_list[i].infection + '" max="'
                                    + rObj.project_list[i].targets + '"></progress>' + infection_percentage
                                    + "%(" + rObj.project_list[i].infection + "명)" + '</td>' // 감염 현황 (파일 실행, 정보 입력 한 사람 수)
                                    + '<td><input disabled id="start_date" type="date" value="' + rObj.project_list[i].start_date + '">'
                                    + '</td><td><input disabled id="end_date_' + rObj.project_list[i].p_no + '" type="date" value="' + rObj.project_list[i].end_date + '">'
                                    + '<button class="btn btn-primary" onclick="modifyEndDate(' + rObj.project_list[i].p_no + ')"><i class="la la-pencil"></i></button></td></tr>');
                            }
                        }
                    } else if (rObj.project_list === null) {
                        // document.getElementById('under').style.background = "#f2eff1";
                        $('#project_list').append('<tr style="background-color:white"><td colspan="12" align="center">' +
                            '<div class="alert alert" style="background-color:white">' +
                            '<p align="center"><span style="border: 1px; font-size:15px;' +
                            'font-style: italic; font-weight: 100;">진행중인 프로젝트가 없습니다.</span></p>' +
                            '</div></td></tr>');
                    }
                } else if (r.status === 403) {
                    Refresh();
                    GetProject();
                }
            }
        };
        r.send();
    }

    function CreateProject() {
        const p_name = $('#p_name').val();
        const p_description = $('#p_description').val();
        const start_date = $('#start_dates').val();
        const end_date = $('#end_dates').val();
        const tmp_no = $('#template').val();
        const tag_1 = $('#tag_1').val();
        const tag_2 = $('#tag_2').val();
        const tag_3 = $('#tag_3').val();
        const tag_array = [];
        if (tag_1 !== "") {
            tag_array.push(tag_1)
        }
        if (tag_2 !== "") {
            tag_array.push(tag_2)
        }
        if (tag_3 !== "") {
            tag_array.push(tag_3)
        }
        const formData = {
            p_name: p_name,
            p_description: p_description,
            start_date: start_date,
            end_date: end_date,
            tmp_no: tmp_no,
            tag_no: tag_array
        };
        console.log(JSON.stringify(formData));

        const r = new XMLHttpRequest();
        r.open('POST', 'http://localhost:5000/api/projectCreate', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            if (r.readyState === 4) {
                if (r.status === 200) {
                    alert("프로젝트 생성이 완료되었습니다.");
                    location.reload();
                } else if (r.status === 403) {
                    Refresh();
                    CreateProject();
                } else if (r.status === 400) {
                    alert("프로젝트 생성에 필요한 정보들이 전부 입력되지 않았거나 \n형식이 올바르지 않습니다.");
                } else if (r.status === 402) {
                    alert("선택한 태그 중에는 훈련대상자가 존재하지 않습니다.");
                } else if (r.status === 405) {
                    alert("프로젝트는 최대 10개 까지만 등록이 가능합니다. ");
                } else if (r.status === 500) {
                    alert("서버에러");
                }
            }
        };
        console.log(formData);
        r.send(JSON.stringify(formData));
    }

    function SmtpSimpleTest() {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://localhost:5000/api/smtpConnectSimpleCheck', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            if (r.readyState === 4) {
                if (r.status === 200) {
                    alert("SMTP 연결 정상");
                } else {
                    alert("SMTP 연결실패, SMTP 정보를 확인해주세요.");
                }
            }
        };
        r.send();
    }

    //종료하기 버튼 누른경우 작동하는 기능
    function ProjectEnd(p_no) {
        const r = new XMLHttpRequest();
        const verify = confirm("해당 프로젝트를 종료하시겠습니까?");
        if (verify === true) {
            r.open('POST', 'http://localhost:5000/api/endProjectList', true);
            r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            r.withCredentials = true;
            r.onreadystatechange = function () {
                if (r.readyState === 4) {
                    if (r.status === 200) {
                        alert('해당 프로젝트가 종료되었습니다.');
                        document.location.reload();
                    } else if (r.status === 403) {
                        Refresh();
                        ProjectEnd(p_no);
                    } else {
                        document.location.href = '/';
                    }
                }
            };
        } else {
            alert("취소되었습니다.");
        }

        console.log(p_no);
        r.send(JSON.stringify({"p_no": p_no}));
    }

    function ProjectStart(p_no) {
        const r = new XMLHttpRequest();
        const verify = confirm("해당 프로젝트를 실행하시겠습니까?");
        if (verify === true) {
            r.open('POST', 'http://localhost:5000/api/startProjectList', true);
            r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            r.withCredentials = true;
            r.onreadystatechange = function () {
                if (r.readyState === 4) {
                    if (r.status === 200) {
                        alert('프로젝트가 시작되었습니다.');
                        document.location.reload();
                    } else if (r.status === 403) {
                        Refresh();
                        ProjectStart(p_no);
                    }
                }
            };
        } else {
            alert("취소되었습니다.");
        }

        console.log(p_no);
        r.send(JSON.stringify({"p_no": p_no}));
    }

    function modifyEndDate(p_no) {
        if (document.getElementById("end_date_" + p_no).disabled) {
            document.getElementById("end_date_" + p_no).disabled = false;
        } else {
            if (!confirm('종료일을 수정하시겠습니까?')) {
                location.reload()
            }
            document.getElementById("end_date_" + p_no).disabled = true;

            const end_date = $('#end_date_' + p_no).val();
            const formData = {
                p_no: p_no,
                end_date: end_date,
            };

            const r = new XMLHttpRequest();
            r.open('POST', 'http://localhost:5000/api/projectModify', true);
            r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            r.withCredentials = true;
            r.onreadystatechange = function () {
                if (r.readyState === 4) {
                    if (r.status === 200) {
                        // alert("프로젝트 종료일이 변경되었습니다.");
                        // location.reload()
                        // console.log('프로젝트 종료일 변경')
                    } else if (r.status === 403) {
                        Refresh();
                        modifyEndDate(p_no);
                    } else if (r.status === 400) {
                        rObj = JSON.parse(r.responseText);
                        if (rObj.dateCompare === true) {
                            alert("적용할 수 없는 종료일입니다")
                            location.reload();
                        }
                    }
                }
            };
            console.log(formData);
            r.send(JSON.stringify(formData));
        }
    }

    $(function () {
        $('#all_select').click(function () {
            if ($("input:checkbox[id='all_select']").prop("checked")) {
                $("input[type=checkbox]").prop("checked", true);
            } else {
                $("input[type=checkbox]").prop("checked", false);
            }
        });

        $('#del_project').click(function () {
            let tbodyTr = $('tbody tr');
            const tdArr = [];	// 배열 선언
            const td = tbodyTr.children();

            td.each(function (i) {
                if (td.eq(i).children().children().prop("checked")) {
                    tdArr.push(td.eq(i - 1).text());
                }
            });
            if (confirm("선택된 프로젝트를 삭제하시겠습니까 ?") === true) {
                if (tdArr.length !== 0) {
                    const r = new XMLHttpRequest();
                    r.open('POST', 'http://localhost:5000/api/delProject', true);
                    r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    r.withCredentials = true;
                    r.onreadystatechange = function () {
                        if (r.readyState === 4) {
                            if (r.status === 200) {
                                alert("삭제가 완료되었습니다.");
                                location.reload();
                            } else if (r.status === 403) {
                                Refresh();
                                alert("세션 만료, 다시 삭제해 주세요.");
                                // Note 위의 알림없이 메서드가 다시 작동하여 삭제되도록 개선 필요.
                            } else {
                                alert("삭제 실패했습니다.");
                            }
                        }
                    };
                    console.log({project_list: tdArr})
                    console.log(tdArr[0])
                    r.send(JSON.stringify({project_list: tdArr}))
                } else {
                    alert("삭제할 대상을 선택해주세요.");
                }

            }
        });
    });

    function OpenModal(i, j) {
        GetTmlDetailPrjMgr(i, j); //todo 김태호 멘티 test 용 추가함.
        $("#tml_viewer").show().center();
    }

    function OpenProjectCreateModal() {
        GetTag();
        GetTmpl();
        $("#project_regist").show().center();
    }

    function CloseProjectCreateModal() {
        $("#project_regist").hide();
    }

    // function CloseProjectModifyModal() {
    //     $("#project_regist").hide();
    // }

    function closeModal() {
        $('#tml_viewer').hide();
    }

    jQuery.fn.center = function () {
        this.css("position", "absolute");
        this.css("top", Math.max(0, (($(window).height() - $(this).outerHeight()) / 2) +
            $(window).scrollTop()) + "px");
        this.css("left", Math.max(0, (($(window).width() - $(this).outerWidth()) / 2) +
            $(window).scrollLeft()) + "px");
        this.css("width", "700px")
        return this;
    }

    function GetTmlDetailPrjMgr(tml_no, p_no) {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://localhost:5000/setting/ProjectDetail?template_no=' + tml_no + '&project_no=' + p_no, true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let rObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    console.log(r.responseText);
                    rObj = JSON.parse(r.responseText);
                    // todo 파싱 해야함 .. 데이터 포멧 보고 하자.
                    // todo 김태호 멘티 자체적으로 포멧 추가..

                    $('#tmp_division').val(rObj.tmpls.tmp_division);
                    $('#tmp_kind').val(rObj.tmpls.tmp_kind);
                    $('#tmp_no').val(rObj.tmpls.tmp_no);
                    $('#tmp_name').val(rObj.tmpls.tmp_name);
                    $('#file_info').val(rObj.tmpls.file_info);
                    $('#sender_name').val(rObj.tmpls.sender_name);
                    $('#title').val(rObj.tmpls.title);
                    CKEDITOR.instances.content.setData(rObj.tmpls.content);
                    CKEDITOR.instances.content.setReadOnly(true);
                    // $('#content').val(rObj.tmpls.content);
                    $('#download_type').val(rObj.tmpls.download_type);

                } else if (r.status === 403) {
                    Refresh();
                    GetTmlDetailPrjMgr(tml_no, p_no);
                }
            }
        };
        r.send();
    }

    function editTml() {
        const tmp_division = $('#tmp_division').val();
        const tmp_kind = $('#tmp_kind').val();
        const tmp_name = $('#tmp_name').val();
        const tmp_no = $('#tmp_no').val();
        const file_info = $('#file_info').val();
        const sender_name = $('#sender_name').val();
        const title = $('#title').val();
        const content = CKEDITOR.instances.content.getData();
        const download_type = $('#download_type').val();

        const formData = {
            tmp_no: parseInt(tmp_no),
            tmp_division: tmp_division,
            tmp_kind: tmp_kind,
            tmp_name: tmp_name,
            file_info: file_info,
            sender_name: sender_name,
            title: title,
            content: content,
            download_type: download_type
        };
        console.log(JSON.stringify(formData));

        const r = new XMLHttpRequest();
        r.open('POST', 'http://localhost:5000/setting/EditTemplate', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            if (r.readyState === 4) {
                if (r.status === 200) {
                    alert("템플릿 수정 완료했습니다.")
                    location.reload()
                } else if (r.status === 403) {
                    Refresh();
                    editTml();
                }
            }
        };
        console.log(formData);
        r.send(JSON.stringify(formData));

    }

    GetDashBoard(); // 비동기 순차처리
    Tg_total(); // 비동기 순차처리
    GetProject();

</script>
</body>

</html>
