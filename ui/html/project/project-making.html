<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#FFFFFF">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" name="viewport">
    <title>REDTEAM | 프로젝트 생성</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito|Roboto">
    <link rel="stylesheet" href="https://maxcdn.icons8.com/fonts/line-awesome/1.1/css/line-awesome.min.css">
    <link rel="stylesheet" href="/css/sport.min.css" type="text/css">
    <link rel="stylesheet" href="/css/choices.min.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.2.1/css/bootstrap-grid.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
</head>

<body>
<!--네이게이터-->
<div class="sidebar">
    <div class="sidebar-header"><a href="#">
        <img src="/image/intro_icon.png" style="max-width: 80%; height: auto;">
    </a>
        <div class="sidebar-control"><i class="la la-navicon"></i></div>
    </div>
    <div class="sidebar-wrapper">
        <ul class="list-menu">
            <li class="header">Total Info</li>

            <li class="tree-item"><a href="/dashboard/total"><i class="la la-group"></i><span>대시보드</span>
                <div class="right-container"></div>
            </a>

            <li class="header">Project Info</li>
            <li class="tree-item"><a href="/project/progress"><i class="la la-group"></i><span>프로젝트 관리</span>
                <div class="right-container"></div>
            </a>

            <li class="tree-item"><a href="/manager/target"><i
                    class="la la-group"></i><span>대상관리</span>
                <div class="right-container"></div>
            </a>

            </li>
            <li class="tree-item"><a href="/manager/template"><i
                    class="la la-file-text"></i><span>템플릿관리</span>
                <div class="right-container"></div>
            </a>
            </li>
            <li class="tree-item active"><a href="/project/create"><i
                    class="la la-pencil-square"></i><span>프로젝트 생성</span>
                <div class="right-container"></div>
            </a>
            </li>
            <li class="header">Setting</li>
            <li class="has-children"><a href="javascript:"><i class="la la-cog"></i><span>설정</span>
                <div class="right-container"><i class="la la-chevron-right tree-icon"></i></div>
            </a>
                <ul class="tree">
                    <li class="tree-item"><a href="/setting/user"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">사용자 정보</span></a></li>
                    <li class="tree-item"><a href="/setting/smtp"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">SMTP 설정</span></a></li>
                </ul>
            </li>
        </ul>
    </div>
</div>
<!--네이게이터-->

<div class="main-content">
    <div class="header">
        <div class="left">
            <p></p>
            <div class="breadcrumb"><span>프로젝트 생성</span></div>
        </div>
        <ul class="right">
            <li class="header-user dropdown ml-4 mr-3"><a class="user-photo trigger-dropdown"><img class="user-img"
                                                                                                   src="/image/user.png"/></a>
                <div class="dropdown-box with-header">
                    <div class="dropdown-header"><img class="user-img user-img--lg"
                                                      src="/image/user.png"/>
                        <div class="user-info">
                            <h3 id="dropdown_name">name</h3><span class="helper-text" id="dropdown_id">email</span>
                        </div>
                    </div>
                    <ul class="dropdown-body">
                        <li><a href="/setting/user" target="_blank"><i
                                class="la la-user"></i><span>사용자 정보</span></a></li>
                        <li><a href="/setting/smtp"><i class="la la-cogs"></i><span>SMTP 설정</span></a>
                        </li>
                        <li><a href="javascript:Logout();"><i class="la la-power-off"></i><span>로그아웃</span></a></li>
                    </ul>
                </div>
            </li>
        </ul>
        <div class="right--mobile"><a class="header-item--mobile sidebar-control"><i class="la la-navicon"></i></a><a
                class="header-item--mobile"><i class="la la-comments"></i></a><a class="header-item--mobile"><i
                class="la la-ellipsis-v"></i></a></div>
    </div>
    <div class="content-wrapper">
        <div class="col-md-5">
            <h5>프로젝트 정보 입력</h5>
            <div class="form-group"><input type="email"
                                                           id="p_name"><label>프로젝트 이름</label>
            </div>
            <div class="form-group"><textarea type="text"
                                                              id="p_description" placeholder="프로젝트 설명"
                                                              cols="50"></textarea></div>
            <div class="form-group label">
                <label for="start_date">프로젝트 시작일</label><input id="start_date" type="date" value="xxx" min="yyy"
                                                               max="zzz">
            </div>
            <div class="form-group label">
                <label for="end_date">프로젝트 종료일</label><input id="end_date" type="date" value="xxx" min="yyy" max="zzz">
            </div>

            <div class="form-group w-50">
                <label for="template">템플릿 선택</label><select id="template">
            </select>
            </div>
            <div class="form-group w-50">
                <label for="tag_1">훈련 대상자 선택(태그) 1(최대 3)</label><select id="tag_1">
            </select>
            </div>
            <div class="form-group w-50">
                <label for="tag_2">훈련 대상자 선택(태그) 2(최대 3)</label><select id="tag_2">
            </select>
            </div>
            <div class="form-group w-50">
                <label for="tag_3">훈련 대상자 선택(태그) 3(최대 3)</label><select id="tag_3">
            </select>
            </div>

            <div class="form-group w-50">
                <button class="btn btn-secondary btn-lg btn-block w-50" onclick="SmtpSimpleTest();">SMTP 연결 테스트
                </button>
            </div>
            <div class="modal__footer">
                <button class="btn btn-primary btn-lg btn-block w-50" id="target_reg" onclick="CreateProject()">등록
                </button>
            </div>
        </div>
    </div>
</div>


<script src="/js/script.js"></script>
<script src="/js/demo.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="/js/jquery.serialize-object.min.js"></script>
<script src="/js/lib/Sortable.min.js"></script>
<script src="/js/main.js"></script>
<script>
    function GetTmplProjectCreate() {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://localhost:5000/setting/getTemplates', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let rObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    rObj = JSON.parse(r.responseText);
                    if (rObj.tmpls.length > 0) {
                        // No, id, 구분, 훈련유형, 첨부파일 정보, 템플릿명, 메일 제목, 발송자명, 다운로드 유형, 등록일
                        // No ,tmp_no , division, kind, file_info, tmp_name, mail_title, sender_name, download_type, created_t
                        $('#template').append("<option value=''>훈련 템플릿 선택하기</option>");
                        for (let i = 0; i < rObj.tmpls.length; i++) {
                            $('#template').append("<option value='" + rObj.tmpls[i].tmp_no + "'>" + rObj.tmpls[i].tmp_name + "</option>");
                        }
                    } else {
                        $('#template').append("<option value=''>등록된 템플릿이 없습니다.</option>");
                    }
                } else if (r.status === 403) {
                    const tokenResult = Refresh();
                    if (tokenResult) {
                        console.log("true")
                    }
                } else {
                    document.location.href = '/';
                }
            }
        };
        r.send();
    }

    function GetTag() {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://localhost:5000/setting/getTag', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let rObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    rObj = JSON.parse(r.responseText);
                    if (rObj.tags.length > 0) {
                        // No, id, 구분, 훈련유형, 첨부파일 정보, 템플릿명, 메일 제목, 발송자명, 다운로드 유형, 등록일
                        // No ,tmp_no , division, kind, file_info, tmp_name, mail_title, sender_name, download_type, created_t
                        $('#tag_1').append("<option value=''>훈련 대상 태그 선택하기</option>");
                        $('#tag_2').append("<option value=''>훈련 대상 태그 선택하기</option>");
                        $('#tag_3').append("<option value=''>훈련 대상 태그 선택하기</option>");
                        for (let i = 0; i < rObj.tags.length; i++) {
                            $('#tag_1').append("<option value='" + rObj.tags[i].tag_no + "'>" + rObj.tags[i].tag_name + "</option>");
                            $('#tag_2').append("<option value='" + rObj.tags[i].tag_no + "'>" + rObj.tags[i].tag_name + "</option>");
                            $('#tag_3').append("<option value='" + rObj.tags[i].tag_no + "'>" + rObj.tags[i].tag_name + "</option>");
                        }
                    } else {
                        $('#tag').append("<option value=''>등록된 대상자가 없습니다.</option>");
                    }
                } else if (r.status === 403) {
                    const tokenResult = Refresh();
                    if (tokenResult) {
                        console.log("true")
                    }
                } else {
                    document.location.href = '/';
                }
            }
        };
        r.send();
    }


    function SmtpSimpleTest() {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://localhost:5000/api/smtpConnectSimpleCheck', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            if (r.readyState === 4) {
                if (r.status === 200) {
                    alert("SMTP 연결 정상");
                } else {
                    alert("SMTP 연결실패, SMTP 정보를 확인해주세요.");
                }
            }
        };
        r.send();
    }

    function CreateProject() {
        const p_name = $('#p_name').val();
        const p_description = $('#p_description').val();
        const start_date = $('#start_date').val();
        const end_date = $('#end_date').val();
        const tmp_no = $('#template').val();
        const tag_1 = $('#tag_1').val();
        const tag_2 = $('#tag_2').val();
        const tag_3 = $('#tag_3').val();
        const tag_array = [];
        if (tag_1 !== "") {
            tag_array.push(tag_1)
        }
        if (tag_2 !== "") {
            tag_array.push(tag_2)
        }
        if (tag_3 !== "") {
            tag_array.push(tag_3)
        }
        const formData = {
            p_name: p_name,
            p_description: p_description,
            start_date: start_date,
            end_date: end_date,
            tmp_no: tmp_no,
            tag_no: tag_array
        };
        console.log(JSON.stringify(formData));

        const r = new XMLHttpRequest();
        r.open('POST', 'http://localhost:5000/api/projectCreate', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            if (r.readyState === 4) {
                if (r.status === 200) {
                    alert("프로젝트 생성이 완료되었습니다.");
                    location.reload()
                } else if (r.status === 403) {
                    const tokenResult = Refresh();
                    if (tokenResult) {
                        console.log("true")
                    }
                } else if (r.status === 400) {
                    alert("프로젝트 생성에 필요한 정보들이 전부 입력되지 않았습니다.");
                }
            }
        };
        console.log(formData);
        r.send(JSON.stringify(formData));
    }
    GetDashBoard();
    GetTag();
    GetTmplProjectCreate();
</script>

</body>

</html>
