<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#FFFFFF">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" name="viewport">
    <title>REDTEAM | 사용자 정보</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito|Roboto">
    <link rel="stylesheet" href="https://maxcdn.icons8.com/fonts/line-awesome/1.1/css/line-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/sport.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.2.1/css/bootstrap-grid.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
</head>

<body>
<!--네이게이터-->
<div class="sidebar">
    <div class="sidebar-header"><a href="#">
        <img src="/image/intro_icon.png" style="max-width: 80%; height: auto;"
             onClick="location.href='/dashboard/total'"/>
    </a>
        <div class="sidebar-control"><i class="la la-navicon"></i></div>
    </div>
    <div class="sidebar-wrapper">
        <ul class="list-menu">
            <li class="header">Total Info</li>
            <li class="tree-item"><a href="/dashboard/total"><i class="la la-group"></i><span>대시보드</span>
                <div class="right-container"></div>
            </a>
            <li class="header">Project Info</li>
            <li class="tree-item"><a href="/project/progress"><i class="la la-group"></i><span>프로젝트 관리</span>
                <div class="right-container"></div>
            </a>
            <li class="tree-item"><a href="/manager/target"><i class="la la-group"></i><span>대상관리</span>
                <div class="right-container"></div>
            </a>

            </li>
            <li class="tree-item"><a href="/manager/template"><i
                    class="la la-file-text"></i><span>템플릿관리</span>
                <div class="right-container"></div>
            </a>
            </li>
<!--            <li class="tree-item"><a href="/project/create"><i-->
<!--                    class="la la-pencil-square"></i><span>프로젝트 생성</span>-->
<!--                <div class="right-container"></div>-->
<!--            </a>-->
<!--            </li>-->
            <li class="header">Setting</li>
            <li class="has-children active"><a href="javascript:;"><i class="la la-cog"></i><span>설정</span>
                <div class="right-container"><i class="la la-chevron-right tree-icon"></i></div>
            </a>
                <ul class="tree">
                    <li class="tree-item"><a href="/setting/user"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">사용자 정보</span></a></li>
                    <li class="tree-item"><a class="active" href="/setting/smtp"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">SMTP 설정</span></a></li>
                </ul>
            </li>
            <li class="header">Help</li>
            <li class="has-children"><a href="javascript:"><i class="la la-question"></i><span>도움말</span>
                <div class="right-container"><i class="la la-chevron-right tree-icon"></i></div>
            </a>
                <ul class="tree">
                    <li class="tree-item"><a href="/help/project"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">프로젝트 관리</span></a></li>
                    <li class="tree-item"><a href="/help/target"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">대상 관리</span></a></li>
                    <li class="tree-item"><a href="/help/template"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">템플릿 관리</span></a></li>
                    <li class="tree-item"><a href="/help/smtp"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">SMTP 설정</span></a></li>
                </ul>
            </li>
        </ul>
    </div>
</div>
<!--네이게이터-->
<div class="main-content">
    <div class="header">
        <div class="left">
            <p></p>
            <div class="breadcrumb"><span>설정</span><span>SMTP 설정</span></div>
        </div>
        <ul class="right">
            <li class="header-user dropdown ml-4 mr-3"><a class="user-photo trigger-dropdown"><img class="user-img"
                                                                                                   src="/image/user.png"/></a>
                <div class="dropdown-box with-header">
                    <div class="dropdown-header"><img class="user-img user-img--lg"
                                                      src="/image/user.png"/>
                        <div class="user-info">
                            <h3 id="dropdown_name">name</h3><span class="helper-text" id="dropdown_id">email</span>
                        </div>
                    </div>
                    <ul class="dropdown-body">
                        <li><a href="/setting/user" target="_blank"><i
                                class="la la-user"></i><span>사용자 정보</span></a></li>
                        <li><a href="/setting/smtp"><i class="la la-cogs"></i><span>SMTP 설정</span></a>
                        </li>
                        <li><a href="javascript:Logout();"><i class="la la-power-off"></i><span>로그아웃</span></a></li>
                    </ul>
                </div>
            </li>
        </ul>
        <div class="right--mobile"><a class="header-item--mobile sidebar-control"><i class="la la-navicon"></i></a><a
                class="header-item--mobile"><i class="la la-comments"></i></a><a class="header-item--mobile"><i
                class="la la-ellipsis-v"></i></a></div>
    </div>
    <div class="content-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-5">
                    <div class="box">
                        <div class="box-header" style="margin-left: 20px">
                            <h3>SMTP 설정</h3>
                        </div>
                        <div class="box-body">
                            <!--                            <div class="form-group label&#45;&#45;floating"><input type="text"-->
                            <!--                                                                           name="hostname"><label>호스트명</label></div>-->
                            <div class="form-group"><label>호스트명</label><input type="text" id="hostname"></div>
                            <!--                            <div class="form-group label&#45;&#45;floating"><input type="text"-->
                            <!--                                                                           name="smtp-port"><label>SMTP 포트</label></div>-->
                            <div class="form-group"><label>SMTP 포트</label><input type="text" id="smtp_port"></div>
                            <div class="form-group w-50"><label>Protocol</label>
                                <!--                                <div class="form-select pgn-select">-->
                                <select id="protocol">
                                    <option value="1" selected>SMTP</option>
                                    <option value="2">Secure SMTP</option>
                                </select>
                                <!--                                </div>-->
                            </div>
                            <div class="form-group w-50"><label>TLS Protocol 사용 여부</label>
                                <!--                                <div class="form-select pgn-select">-->
                                <select id="tls_protocol">
                                    <option value="1" selected>사용</option>
                                    <option value="2">미사용</option>
                                </select>
                                <!--                            </div>-->
                            </div>
                            <!--                            <div class="form-group label&#45;&#45;floating with-addon addon&#45;&#45;right"><span> <i-->
                            <!--                                    class="fa fa-eye-slash"></i></span><input type="text" name="timeout"><label>타임아웃(MilliSeconds)</label>-->
                            <!--                            </div>-->
                            <div class="form-group"><label>타임아웃(MilliSeconds)</label><input type="text" id="timeout">
                            </div>
                            <div class="form-group label--floating"><span></span><input type="text"
                                                                                        id="smtp_id"><label>SMTP-ID</label>
                            </div>
                            <div class="form-group label--floating with-addon addon--right"><span> <i
                                    class="fa fa-eye-slash"></i></span><input type="password" id="smtp_pw"><label>SMTP-PW</label>
                            </div>
                        </div>

                        <button class="btn btn-secondary btn-lg btn-block" onclick="SmtpConnectionTest();">연결 테스트
                        </button>
                        <button class="btn btn-primary btn-lg btn-block" onclick="SetSmtpSetting();">SMTP 설정 저장</button>
                        <!--                            <button class="btn btn-md btn-primary">Submit</button>-->
                        <!--                            <div class="col-md-3 mb-2"><button class="btn btn-primary btn-lg btn-block">Pugna Primary</button></div>-->

                    </div>
                </div>
            </div>
        </div>
        <div class="footer"><span><b>Pugna</b> - Admin Template by <a href="https://github.com/aljazari-studio/pugna"
                                                                      target="_blank">Al Jazari Studio</a></span></div>
    </div>
</div>
<script src="/js/main.js"></script>
<script src="/js/script.js"></script>
<script src="/js/demo.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="/js/jquery.serialize-object.min.js"></script>
<script type="text/javascript">
    function GetSmtpSetting() {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://localhost:5001/setting/smtpSetting', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let responseObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    console.log(r.responseText);
                    responseObj = JSON.parse(r.responseText);
                    $('#hostname').val(responseObj.smtp_setting.smtp_host);
                    $('#smtp_port').val(responseObj.smtp_setting.smtp_port);
                    $('#protocol').val(responseObj.smtp_setting.smtp_protocol);
                    $('#tls_protocol').val(responseObj.smtp_setting.smtp_tls);
                    $('#timeout').val(responseObj.smtp_setting.smtp_timeout);
                    // console.log($('#protocol option:selected').val());
                    // console.log($('#tls_protocol option:selected').val());
                } else if (r.status === 403) {
                    if (Verify()) {
                        Refresh();
                        GetSmtpSetting();
                    } else {
                        document.location.href = '/';
                    }
                } else {
                    document.location.href = '/';
                }
            }
        };
        r.send();
    }

    function SetSmtpSetting() {
        const hostname = $('#hostname').val();
        const smtp_port = $('#smtp_port').val();
        const protocol = $('#protocol').val();
        const tls_protocol = $('#tls_protocol').val();
        const timeout = $('#timeout').val();
        const smtp_id = $('#smtp_id').val();
        const smt_pw = $('#smtp_pw').val();
        const formData = {
            smtp_host: hostname,
            smtp_port: smtp_port,
            smtp_protocol: protocol,
            smtp_tls: tls_protocol,
            smtp_timeout: timeout,
            smtp_id: smtp_id,
            smtp_pw: smt_pw
        };

        const r = new XMLHttpRequest();
        r.open('POST', 'http://localhost:5001/setting/smtpSetting', true);
        r.setRequestHeader("Content-Type", "application/json");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            if (r.readyState === 4) {
                if (r.status === 200) {
                    alert("SMTP 정보가 저장되었습니다.");
                    location.reload();
                } else if (r.status === 400) {
                    alert("SMTP 정보를 확인해주세요.");
                } else if (r.status === 403) {
                    if (Verify()) {
                        Refresh();
                        SetSmtpSetting();
                    } else {
                        document.location.href = '/';
                    }
                } else if (r.status === 409) {
                    alert("비밀번호를 확인해주세요.");
                }
            }
        };
        r.send(JSON.stringify(formData));
        // console.log(formData);
    }

    function SmtpConnectionTest() {
        const hostname = $('#hostname').val();
        const smtp_port = $('#smtp_port').val();
        const protocol = $('#protocol').val();
        const tls_protocol = $('#tls_protocol').val();
        const timeout = $('#timeout').val();
        const smtp_id = $('#smtp_id').val();
        const smt_pw = $('#smtp_pw').val();
        const formData = {
            smtp_host: hostname,
            smtp_port: smtp_port,
            smtp_protocol: protocol,
            smtp_tls: tls_protocol,
            smtp_timeout: timeout,
            smtp_id: smtp_id,
            smtp_pw: smt_pw
        };

        const r = new XMLHttpRequest();
        r.open('POST', 'http://localhost:5001/setting/smtpConnectCheck', true);
        r.setRequestHeader("Content-Type", "application/json");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            if (r.readyState === 4) {
                if (r.status === 200) {
                    alert("SMTP 연결 완료");
                } else if (r.status === 403) {
                    if (Verify()) {
                        Refresh();
                        SmtpConnectionTest();
                    } else {
                        document.location.href = '/';
                    }
                } else {
                    responseObj = r.responseText;
                    alert(responseObj)
                    // responseObj = JSON.parse(r.responseText);
                    // alert("SMTP 정보를 확인해주세요.\n"+responseObj.error.Msg);
                }
            }
        };
        r.send(JSON.stringify(formData));

    }

    function SmtpSendMailTest() {
        const hostname = $('#hostname').val();
        const smtp_port = $('#smtp_port').val();
        const protocol = $('#protocol').val();
        const tls_protocol = $('#tls_protocol').val();
        const timeout = $('#timeout').val();
        const smtp_id = $('#smtp_id').val();
        const smt_pw = $('#smtp_pw').val();
        const formData = {
            smtp_host: hostname,
            smtp_port: smtp_port,
            smtp_protocol: protocol,
            smtp_tls: tls_protocol,
            smtp_timeout: timeout,
            smtp_id: smtp_id,
            smtp_pw: smt_pw
        };

        const r = new XMLHttpRequest();
        r.open('POST', 'http://localhost:5001/setting/smtpSendTest', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            if (r.readyState === 4) {
                if (r.status === 200) {
                    alert("SMTP 연결 완료");
                } else if (r.status === 403) {
                    if (Verify()) {
                        Refresh();
                        SmtpSendMailTest();
                    } else {
                        document.location.href = '/';
                    }
                } else {
                    responseObj = JSON.parse(r.responseText);
                    alert("SMTP 정보를 확인해주세요.\n"+responseObj.error.Msg);
                }
            }
        };
        r.send(JSON.stringify(formData));
    }

    GetDashBoard();
    GetSmtpSetting();
</script>
</body>

</html>
