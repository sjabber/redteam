<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#FFFFFF">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" name="viewport">
    <title>REDTEAM | 대상관리</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito|Roboto">
    <link rel="stylesheet" href="https://maxcdn.icons8.com/fonts/line-awesome/1.1/css/line-awesome.min.css">
    <link rel="stylesheet" href="/css/sport.min.css" type="text/css">
    <link rel="stylesheet" href="/css/sport.css" type="text/css">
    <link rel="stylesheet" href="/css/choices.min.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.2.1/css/bootstrap-grid.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
</head>

<body>
<!--네이게이터-->
<div class="sidebar">
    <div class="sidebar-header"><a href="#">
        <img src="/image/intro_icon.png" style="max-width: 80%; height: auto;"
             onClick="location.href='/dashboard/total'"/>
    </a>
        <div class="sidebar-control"><i class="la la-navicon"></i></div>
    </div>
    <div class="sidebar-wrapper">
        <ul class="list-menu">
            <li class="header">Total Info</li>
            <li class="tree-item"><a href="/dashboard/total"><i class="la la-group"></i><span>대시보드</span>
                <div class="right-container"></div>
            </a>
            <li class="header">Project Info</li>
            <li class="tree-item"><a href="/project/progress"><i class="la la-group"></i><span>프로젝트 관리</span>
                <div class="right-container"></div>
            </a>
            <li class="tree-item active"><a href="/manager/target"><i
                    class="la la-group"></i><span>대상관리</span>
                <div class="right-container"></div>
            </a>

            </li>
            <li class="tree-item"><a href="/manager/template"><i
                    class="la la-file-text"></i><span>템플릿관리</span>
                <div class="right-container"></div>
            </a>
            </li>
            <!--            <li class="tree-item"><a href="/project/create"><i-->
            <!--                    class="la la-pencil-square"></i><span>프로젝트 생성</span>-->
            <!--                <div class="right-container"></div>-->
            <!--            </a>-->
            <!--            </li>-->
            <li class="header">Setting</li>
            <li class="has-children"><a href="javascript:"><i class="la la-cog"></i><span>설정</span>
                <div class="right-container"><i class="la la-chevron-right tree-icon"></i></div>
            </a>
                <ul class="tree">
                    <li class="tree-item"><a href="/setting/user"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">사용자 정보</span></a></li>
                    <li class="tree-item"><a href="/setting/smtp"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">SMTP 설정</span></a></li>
                </ul>
            </li>
            <li class="header">Help</li>
            <li class="has-children"><a href="javascript:"><i class="la la-question"></i><span>도움말</span>
                <div class="right-container"><i class="la la-chevron-right tree-icon"></i></div>
            </a>
                <ul class="tree">
                    <li class="tree-item"><a href="/help/project"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">프로젝트 관리</span></a></li>
                    <li class="tree-item"><a href="/help/target"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">대상 관리</span></a></li>
                    <li class="tree-item"><a href="/help/template"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">템플릿 관리</span></a></li>
                    <li class="tree-item"><a href="/help/smtp"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">SMTP 설정</span></a></li>
                </ul>
            </li>
        </ul>
    </div>
</div>
<!--네이게이터-->


<div class="main-content">
    <div class="header">
        <div class="left">
            <p></p>
            <div class="breadcrumb"><span>대상관리</span></div>
        </div>


        <ul class="right">
            <li class="header-user dropdown ml-4 mr-3"><a class="user-photo trigger-dropdown"><img class="user-img"
                                                                                                   src="/image/user.png"/></a>
                <div class="dropdown-box with-header">
                    <div class="dropdown-header"><img class="user-img user-img--lg"
                                                      src="/image/user.png"/>
                        <div class="user-info">
                            <h3 id="dropdown_name">name</h3><span class="helper-text" id="dropdown_id">email</span>
                        </div>
                    </div>
                    <ul class="dropdown-body">
                        <li><a href="/setting/user" target="_blank"><i
                                class="la la-user"></i><span>사용자 정보</span></a></li>
                        <li><a href="/setting/smtp"><i class="la la-cogs"></i><span>SMTP 설정</span></a>
                        </li>
                        <li><a href="javascript:Logout();"><i class="la la-power-off"></i><span>로그아웃</span></a></li>
                    </ul>
                </div>
            </li>
        </ul>

        <div class="right--mobile"><a class="header-item--mobile sidebar-control"><i class="la la-navicon"></i></a><a
                class="header-item--mobile"><i class="la la-comments"></i></a><a class="header-item--mobile"><i
                class="la la-ellipsis-v"></i></a></div>
    </div>
    <div class="content-wrapper">
        <div class="row">
            <div class="col-12">
                <div class="box">
                    <div class="box-header">
                        <h3>모든 대상자</h3>
                        <div class="toolbox" style="justify-content: center;">
                            <div class="row p-3">
                                <button class="btn btn-c-success" style="margin-left: 10px;" id="reg_tag"
                                        data-modal="#tag_registry">태그 관리
                                </button>
                                <div class="btn-group" style="margin-left: 10px;">
                                    <button class="btn btn-primary active" id="reg_target"
                                            data-modal="#target_registry">
                                        <span>대상자 등록</span></button>
                                    <button class="btn btn-primary" id="del_target"><span>대상자 삭제</span></button>
                                </div>
                                <div class="btn-group" style="margin-left: 10px;">
                                    <button class="btn btn-primary active" id="reg_targets"
                                            data-modal="#registry_targets"><span>대상자 일괄등록</span>
                                    </button>
                                    <button class="btn btn-primary" id="export_targets" data-modal="#exported_targets">
                                        <span>대상자 내보내기</span></button>
                                </div>
                                <form action id="search_box" style="margin-left: 10px">
                                    <div class="search_box" style="margin-left: 10px">
                                        <select id="search_division" style="height: 30px; font-size: 16px;
                                            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
                                            display: inline-block; padding: 0 17px 0 5px;
                                            border: 1px solid #d5d5d5; background: transparent; color: #959595;
                                            line-height: 24px; vertical-align: top; width: 100px;">
                                            <option value="target_name">이름</option>
                                            <option value="target_email">이메일</option>
                                            <option value="target_phone">연락처</option>
                                            <option value="target_organize">소속</option>
                                            <option value="target_position">직급</option>
                                        </select>
                                        <input style="font-size: 14px; margin-right: 1px; width: 200px; height: 30px;
                                           padding-left: 10px" type="text" id="search_text"
                                               placeholder="검색어를 입력하세요.">
                                        <button id="search_button" style="margin-right: 10px">검색</button>
                                    </div>

                                </form>
                                <!--                                <a><i class="la la-plus"></i></a>-->
                                <a class="trigger-dropdown"><i
                                        class="la la-ellipsis-h"></i></a>
                                <ul class="dropdown-box">
                                    <li><a><i class="la la-sort-alpha-asc"></i><span>a to z</span></a></li>
                                    <li><a><i class="la la-sort-alpha-desc"></i><span>z to a</span></a></li>
                                    <li><a><i class="la la-filter"></i><span>Custom filter</span></a></li>
                                </ul>
                            </div>

                        </div>
                    </div>
                    <div class="pgn-modal" id="tag_registry">
                        <div class="pgn-modal-wrapper">
                            <div class="modal__header">
                                <h5>태그 관리</h5>
                                <div class="toolbox">
                                    <button class="btn-modal-close modal-dismiss"><i class="la la-times"></i></button>
                                </div>
                            </div>
                            <div class="modal__body">
                                <div class="form-group label--floating"><input type="text"
                                                                               id="tag_name"><label>태그명</label>
                                </div>
                                <div class="box-body pt-0 px-0 responsive">
                                    <table id="tag_menage">
                                        <thead>
                                        <tr>
                                            <th>태그명</th>
                                            <th>등록날짜</th>
                                            <th>삭제</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal__footer">
                                <button class="btn btn-ghost modal-dismiss">취소</button>
                                <button class="btn btn-primary pull-right" id="tag_reg">등록</button>
                            </div>
                        </div>
                    </div>

                    <div class="pgn-modal" id="target_registry">
                        <div class="pgn-modal-wrapper">
                            <div class="modal__header">
                                <h5>대상자 등록</h5>
                                <div class="toolbox">
                                    <button class="btn-modal-close modal-dismiss"><i class="la la-times"></i></button>
                                </div>
                            </div>
                            <div class="modal__body">
                                <div class="form-group label--floating"><input type="email"
                                                                               id="target_email"><label>이메일 (필수)</label>
                                </div>
                                <div class="form-group label--floating"><input type="text"
                                                                               id="target_name"><label>이름 (필수)</label>
                                </div>
                                <div class="form-group label--floating"><input type="text"
                                                                               onkeyup="inputPhoneNumber(this);"
                                                                               maxlength="13"
                                                                               id="target_phone"><label>전화번호
                                    (권장)</label>
                                </div>
                                <div class="form-group label--floating"><input type="text"
                                                                               id="target_organ"><label>소속 (권장)</label>
                                </div>
                                <div class="form-group label--floating"><input type="text" id="target_position"><label>직급
                                    (권장)</label>
                                </div>
                                <div class="form-group w-50">
                                    <label for="tag_selector_1">태그</label><select id="tag_selector_1">
                                </select>
                                </div>
                                <div class="form-group w-50">
                                    <label for="tag_selector_2">태그</label><select id="tag_selector_2">
                                </select>
                                </div>
                                <div class="form-group w-50">
                                    <label for="tag_selector_3">태그</label><select id="tag_selector_3">
                                </select>
                                </div>
                            </div>
                            <div class="modal__footer">
                                <button class="btn btn-ghost modal-dismiss">취소</button>
                                <button class="btn btn-primary pull-right" id="target_reg">등록</button>
                            </div>
                        </div>
                    </div>

                    <div class="pgn-modal" id="registry_targets">
                        <div class="pgn-modal-wrapper">
                            <div class="modal__header">
                                <h5>대상자 일괄등록</h5>
                                <div class="toolbox">
                                    <button class="btn-modal-close modal-dismiss"><i class="la la-times"></i></button>
                                </div>
                            </div>
                            <div class="modal__body">
                                <div class="row p-3 form-group">
                                    <label>엑셀 양식으로 한번에 여러 대상자를 추가</label>
                                    <button id="excelDownload" class="btn btn-secondary btn-lg btn-block">엑셀 양식 다운로드
                                    </button>
                                </div>
                                <div class="form-group"><label>양식 업로드</label>
                                    <div class="form-file">
                                        <button class="btn-file"><i class="la la-upload"></i></button>
                                        <input type="file" id="file" name="file">
                                        <div class="file-container">
                                            <p id="uploadFileName">TargetUpload.xlsx</p>
                                            <progress value="22" max="100"></progress>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal__footer">
                                <button class="btn btn-ghost modal-dismiss" id="cancel-btn">취소</button>
                                <button class="btn btn-primary pull-right" id="excelUpload-btn">등록</button>
                            </div>
                        </div>
                    </div>

                    <div class="pgn-modal" id="exported_targets">
                        <div class="pgn-modal-wrapper">
                            <div class="modal__header">
                                <h5>대상자 내보내기</h5>
                                <div class="toolbox">
                                    <button class="btn-modal-close modal-dismiss"><i class="la la-times"></i></button>
                                </div>
                            </div>
                            <div class="modal__body">
                                <div class="form-group w-50">
                                    <label for="tag_selector2">태그 선택</label><select id="tag_selector2">
                                    <option value=0 selected>전체</option>
                                </select>
                                </div>
                            </div>
                            <div class="modal__footer">
                                <button class="btn btn-ghost modal-dismiss">취소</button>
                                <button class="btn btn-primary pull-right" id="btn_export">내보내기</button>
                            </div>
                        </div>
                    </div>

                    <div class="toolbox">
                        <div class="box-body pt-0 px-0 responsive">
                            <table id="targets">
                                <thead>
                                <tr>
                                    <th style="visibility:hidden;position:absolute;"></th>
                                    <th>
                                        <div class="pgn-checkbox"><input type="checkbox" id="all_select"><span></span>
                                        </div>
                                    </th>
                                    <th>No</th>
                                    <th>이름(이메일)</th>
                                    <th>연락처</th>
                                    <th>소속</th>
                                    <th>직급</th>
                                    <th>등록일</th>
                                    <th>태그</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="pagination-wrapper clearfix" id="under">
                        <ul class="pagination float--right" id="pages">
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="/js/main.js"></script>
<script src="/js/script.js"></script>
<script src="/js/demo.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="/js/jquery.serialize-object.min.js"></script>
<script src="/js/lib/Sortable.min.js"></script>
<script>
    // 계정별 태그정보 (최대 5개)
    var tg_total = [5];

    function GetTarget(page) {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://localhost:5000/api/target/getTarget?page=' + page, false);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let rObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    rObj = JSON.parse(r.responseText);
                    console.log(r.responseText);

                    if (rObj.targets != null) {
                        // table 비워주기
                        $('#targets > tbody').empty();
                        for (let i = 0; i < rObj.targets.length; i++) {
                            // 태그 분리해주는 작업 ..
                            let full_tag = ''
                            for (let j = 0; j < rObj.targets[i].tg_tag.length; j++) {
                                // console.log(rObj.targets[i].tg_tag[j])
                                if (rObj.targets[i].tg_tag[j] !== "") {

                                    if (tg_total[0] === rObj.targets[i].tg_tag[j]) {
                                        full_tag += '<label id="label1">' + rObj.targets[i].tg_tag[j] + '</label>'
                                    } else if (tg_total[1] === rObj.targets[i].tg_tag[j]) {
                                        full_tag += '<label id="label2">' + rObj.targets[i].tg_tag[j] + '</label>'
                                    } else if (tg_total[2] === rObj.targets[i].tg_tag[j]) {
                                        full_tag += '<label id="label3">' + rObj.targets[i].tg_tag[j] + '</label>'
                                    } else if (tg_total[3] === rObj.targets[i].tg_tag[j]) {
                                        full_tag += '<label id="label4">' + rObj.targets[i].tg_tag[j] + '</label>'
                                    } else if (tg_total[4] === rObj.targets[i].tg_tag[j]) {
                                        full_tag += '<label id="label5">' + rObj.targets[i].tg_tag[j] + '</label>'
                                    }

                                    // if (j === 0) {
                                    //     full_tag += '<label id="label1">' + rObj.targets[i].tg_tag[j] + '</label>'
                                    //     // full_tag += '<label class="badge badge-green">' + rObj.targets[i].tg_tag[j] + '</label>'
                                    // } else if (j === 1) {
                                    //     full_tag += '<label id="label1">' + rObj.targets[i].tg_tag[j] + '</label>'
                                    //     // full_tag += '<label class="badge badge-red">' + rObj.targets[i].tg_tag[j] + '</label>'
                                    // } else if (j === 2) {
                                    //     full_tag += '<label id="label1">' + rObj.targets[i].tg_tag[j] + '</label>'
                                    //     // full_tag += '<label class="badge badge-blue">' + rObj.targets[i].tg_tag[j] + '</label>'
                                    // }
                                }
                            }

                            var phone = "";

                            if (rObj.targets[i].tg_phone.length < 10) {
                                //case : 02-xxx-xxxx
                                phone += rObj.targets[i].tg_phone.substr(0, 2);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(2, 3);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(5, 4);
                            } else if (rObj.targets[i].tg_phone.substr(1, 1) === "2" && rObj.targets[i].tg_phone.length === 10) {
                                //case : 02-xxxx-xxxx
                                phone += rObj.targets[i].tg_phone.substr(0, 2);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(2, 4);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(6, 4);
                            } else if (rObj.targets[i].tg_phone.length === 10) {
                                phone += rObj.targets[i].tg_phone.substr(0, 3);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(3, 3);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(6, 4);
                            } else if (rObj.targets[i].tg_phone.length === 11) {
                                phone += rObj.targets[i].tg_phone.substr(0, 3);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(3, 4);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(7, 4);
                            }

                            if (full_tag === '') {
                                $('#targets > tbody:last').append('<tr>' + '<td id=' + rObj.targets[i].tg_no +
                                    '" style="visibility:hidden;position:absolute;">' + rObj.targets[i].tg_no + '</td><td><div class="pgn-checkbox"><input type="checkbox" name="">' +
                                    '<span></span></div></td><td>' + rObj.targets[i].fake_no + '</td><td>' +
                                    rObj.targets[i].tg_name + "(" +
                                    rObj.targets[i].tg_email + ")" + '</td><td>' + phone + '</td><td>' + rObj.targets[i].tg_organize +
                                    '</td><td>' + rObj.targets[i].tg_position + '</td><td>' + rObj.targets[i].created_t + '</td>' +
                                    '<td></td></tr>');
                            } else {
                                $('#targets > tbody:last').append('<tr><td id="target_' + rObj.targets[i].tg_no +
                                    '" style="visibility:hidden;position:absolute;">' + rObj.targets[i].tg_no + '</td><td><div class="pgn-checkbox"><input type="checkbox" name="">' +
                                    '<span></span></div></td><td>' + rObj.targets[i].fake_no + '</td><td>' +
                                    rObj.targets[i].tg_name + "(" +
                                    rObj.targets[i].tg_email + ")" + '</td><td>' + phone + '</td><td>' + rObj.targets[i].tg_organize +
                                    '</td><td>' + rObj.targets[i].tg_position + '</td><td>' + rObj.targets[i].created_t + '</td>' +
                                    '<td>' + full_tag + '</td></tr>');
                            }
                        }
                    } else {
                        $('#targets > tbody:last').append('<tr style="background-color:white"><td colspan="10" align="center">' +
                            '<div class="alert alert" style="background-color:white">' +
                            '<p align="center">Info<span style="border: 1px; font-size:15px;' +
                            'font-style: italic; font-weight: 100;">등록된 대상자가 없습니다.</span></p>' +
                            '</div></td></tr>');
                    }

                    // console.log(rObj.total);
                    paging(rObj.total, page);

                } else if (r.status === 403) {
                    if (Verify()) {
                        Refresh();
                        GetTarget(page);
                    } else {
                        document.location.href = '/';
                    }
                } else {
                    document.location.href = '/';
                }
            }
        };
        r.send();
    }

    function getTagForTargetInfo() {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://localhost:5000/setting/getTag', false);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let rObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    rObj = JSON.parse(r.responseText);
                    if (rObj.tags.length > 0) {
                        //console.log(r.responseText);
                        $('#tag_menage > tbody').empty();
                        $('#tag_select').empty();
                        for (let j = 0; j < rObj.tags.length; j++) {
                            tg_total[j] = rObj.tags[j].tag_name;

                            $('#tag_menage >tbody:last').append("<tr id='tag_" + rObj.tags[j].tag_no + "'>" +
                                "                        <td>" + rObj.tags[j].tag_name + "</td>\n" +
                                "                        <td>" + rObj.tags[j].created_t + "</td>\n" +
                                "                        <td>\n" +
                                "                        <button class=\"btn btn-secondary\" onclick='deleteTag(" + rObj.tags[j].tag_no + ")'><i class=\"la la-trash\"></i></button>\n" +
                                "                        </td>\n" +
                                "                        </tr>");
                            if (j === 0) {
                                // const option = ;
                                console.log(rObj.tags[j].tag_no);
                                $('#tag_selector_1').append("<option value='" + "" + "' selected>" + "선택안함" + "</option>");
                                $('#tag_selector_2').append("<option value='" + "" + "' selected>" + "선택안함" + "</option>");
                                $('#tag_selector_3').append("<option value='" + "" + "' selected>" + "선택안함" + "</option>");

                                $('#tag_selector_1').append("<option value='" + rObj.tags[j].tag_no + "' >" + rObj.tags[j].tag_name + "</option>");
                                $('#tag_selector_2').append("<option value='" + rObj.tags[j].tag_no + "' >" + rObj.tags[j].tag_name + "</option>");
                                $('#tag_selector_3').append("<option value='" + rObj.tags[j].tag_no + "' >" + rObj.tags[j].tag_name + "</option>");
                                $('#tag_selector2').append("<option value='" + rObj.tags[j].tag_no + "'>" + rObj.tags[j].tag_name + "</option>");
                            } else {
                                $('#tag_selector_1').append("<option value='" + rObj.tags[j].tag_no + "' >" + rObj.tags[j].tag_name + "</option>");
                                $('#tag_selector_2').append("<option value='" + rObj.tags[j].tag_no + "' >" + rObj.tags[j].tag_name + "</option>");
                                $('#tag_selector_3').append("<option value='" + rObj.tags[j].tag_no + "' >" + rObj.tags[j].tag_name + "</option>");
                                $('#tag_selector2').append("<option value='" + rObj.tags[j].tag_no + "'>" + rObj.tags[j].tag_name + "</option>");
                            }
                        }
                    } else {
                        $('#tag_menage > tbody:last').append('<tr><td colspan="3"><div class="alert alert">\n' +
                            '                  <p>Info<span>등록된 태그가 존재하지 않습니다.</span></p>\n' +
                            '                </div></tr></td>');
                    }
                } else if (r.status === 403) {
                    if (Verify()) {
                        Refresh();
                        getTagForTargetInfo();
                    } else {
                        document.location.href = '/';
                    }
                } else {
                    document.location.href = '/';
                }
            }
        };
        r.send();
    }

    function deleteTag(tagNo) {
        const r = new XMLHttpRequest();
        r.open('POST', 'http://localhost:5000/api/target/delTag', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            if (r.readyState === 4) {
                if (r.status === 200) {
                    alert('태그가 삭제되었습니다.');
                    document.location.reload();

                    $('#tag_' + tagNo).remove();
                } else if (r.status === 403) {
                    if (Verify()) {
                        Refresh();
                        //Note 추후 자기 자신을 다시 호출하도록 개선
                        //deleteTag(tagNo);
                    } else {
                        document.location.href = '/';
                    }
                } else {
                    document.location.href = '/';
                }
            }
        };

        console.log(tagNo);
        r.send(JSON.stringify({"tag_no": tagNo}));
    }

    function paging(totalData, currentPage) {
        const dataPerPage = 20;
        const pageCount = 5;

        console.log("currentPage : " + currentPage);
        console.log("totalData : " + totalData);
        const totalPage = Math.ceil(totalData / dataPerPage);    // 총 페이지 수
        const pageGroup = Math.ceil(currentPage / pageCount);    // 페이지 그룹

        console.log("pageGroup : " + pageGroup);
        console.log("totalPage : " + totalPage);

        let last = pageGroup * pageCount;    // 화면에 보여질 마지막 페이지 번호
        if (last > totalPage)
            last = totalPage;
        let first = last - (pageCount - 1);    // 화면에 보여질 첫번째 페이지 번호
        const next = last + 1;
        const prev = first - 1;

        console.log("last : " + last);
        console.log("first : " + first);
        console.log("next : " + next);
        console.log("prev : " + prev);

        if (totalPage < 1) {
            first = last;
        }
        const pages = $("#pages");
        pages.empty();
        if (first > 5) {
            pages.append("<li class=\"pagination-item\">" +
                "<a onclick=\"GetTarget(" + (prev) + ");\" style='margin-left: 2px'>prev</a></li>");
        }
        for (let j = first; j <= last; j++) {
            if (currentPage === (j)) {
                pages.append("<li class=\"pagination-item\">" +
                    "<a class='active' onclick=\"GetTarget(" + (j) + ");\" style='margin-left: 2px'>" + (j) + "</a></li>");
            } else if (j > 0) {
                pages.append("<li class=\"pagination-item\">" +
                    "<a onclick=\"GetTarget(" + (j) + ");\" style='margin-left: 2px'>" + (j) + "</a></li>");
            }
        }
        if (next > 5 && next < totalPage) {
            pages.append("<li class=\"pagination-item\">" +
                "<a onclick=\"GetTarget(" + (next) + ");\" style='margin-left: 2px'>next</a></li>");
        }
    }

    $(function () {
        $('#all_select').click(function () {
            if ($("input:checkbox[id='all_select']").prop("checked")) {
                $("input[type=checkbox]").prop("checked", true);
            } else {
                $("input[type=checkbox]").prop("checked", false);
            }
        });
        $('#del_target').click(function () {
            let tbodyTr = $('tbody tr');
            const tdArr = [];	// 배열 선언
            const td = tbodyTr.children();

            td.each(function (i) {
                if (td.eq(i).children().children().prop("checked")) {
                    tdArr.push(td.eq(i - 1).text());
                }
            });
            if (confirm("선택된 대상자를 삭제하시겠습니까 ?") === true) {
                if (tdArr.length !== 0) {
                    const r = new XMLHttpRequest();
                    r.open('POST', 'http://localhost:5000/api/target/delTarget', true);
                    r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    r.withCredentials = true;
                    r.onreadystatechange = function () {
                        if (r.readyState === 4) {
                            if (r.status === 200) {
                                alert("삭제가 완료되었습니다.");
                                location.reload();
                            } else if (r.status === 403) {
                                if (Verify()) {
                                    Refresh();
                                    //Note 추후 자기 자신을 다시 호출하도록 개선
                                } else {
                                    document.location.href = '/';
                                }
                            } else {
                                alert("삭제 실패했습니다.");
                            }
                        }
                    };
                    console.log({target_list: tdArr})
                    console.log(tdArr[0])
                    r.send(JSON.stringify({target_list: tdArr}))
                } else {
                    alert("삭제할 대상을 선택해주세요.");
                }

            }
        });

        $('#tag_reg').click(function () {
            const r = new XMLHttpRequest();
            r.open('POST', 'http://localhost:5000/api/target/regTag', true);
            r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            r.withCredentials = true;
            r.onreadystatechange = function () {
                let rObj;
                ``
                if (r.readyState === 4) {
                    if (r.status === 200) {
                        alert('태그가 등록되었습니다.');
                        document.location.reload();

                        rObj = JSON.parse(r.responseText);
                        $('#tag_menage > tbody').append("<tr id='tag_" + rObj.tags.tag_no + "'>" +
                            "                        <td>" + rObj.tags.tag_name + "</td>\n" +
                            "                        <td>" + rObj.tags.created_t + "</td>\n" +
                            "                        <td>\n" +
                            "                        <button class=\"btn btn-secondary\" onclick='deleteTag(" + rObj.tags.tag_no + ")'><i class=\"la la-trash\"></i></button>\n" +
                            "                        </td>\n" +
                            "                        </tr>");

                    } else if (r.status === 400) {
                        alert('해당 태그가 이미 존재하거나 형식이 올바르지 않습니다. \n(특수문자 사용불가)');
                    } else if (r.status === 403) {
                        if (Verify()) {
                            Refresh();
                            //Note 추후 자기 자신을 다시 호출하도록 개선
                        } else {
                            document.location.href = '/';
                        }
                    } else if (r.status === 405) {
                        alert('태그는 최대 5개까지만 등록이 가능합니다.');
                    } else if (r.status === 500) {
                        alert('서버에러');
                    } else {
                        rObj = JSON.parse(r.responseText);
                        alert(rObj.err);
                        // document.location.href = '/';
                    }
                }
            };
            r.send(JSON.stringify({"tag_name": $('#tag_name').val()}));
        });

        $('#target_reg').click(function () {

            var phone = "";

            if ($('#target_phone').val().length < 12) {
                //case : 02-xxx-xxxx
                phone += $('#target_phone').val().substr(0, 2);
                phone += $('#target_phone').val().substr(3, 3);
                phone += $('#target_phone').val().substr(7, 4);
            } else if ($('#target_phone').val().substr(1, 1) === "2" && $('#target_phone').val().length === 12) {
                //case : 02-xxxx-xxxx
                phone += $('#target_phone').val().substr(0, 2);
                phone += $('#target_phone').val().substr(3, 4);
                phone += $('#target_phone').val().substr(8, 4);
            } else if ($('#target_phone').val().length === 12) {
                phone += $('#target_phone').val().substr(0, 3);
                phone += $('#target_phone').val().substr(4, 3);
                phone += $('#target_phone').val().substr(8, 4);
            } else if ($('#target_phone').val().length === 13) {
                phone += $('#target_phone').val().substr(0, 3);
                phone += $('#target_phone').val().substr(4, 4);
                phone += $('#target_phone').val().substr(9, 4);
            }

            // console.log(phone);

            const tg_email = $('#target_email').val();
            const tg_name = $('#target_name').val();
            const tg_phone = phone;
            const tg_organ = $('#target_organ').val();
            const tg_position = $('#target_position').val();
            const tag_no_1 = $('#tag_selector_1').val();
            const tag_no_2 = $('#tag_selector_2').val();
            const tag_no_3 = $('#tag_selector_3').val();
            const tag_array = [];

            if (tag_no_1 !== "") {
                tag_array.push(tag_no_1)
            }
            if (tag_no_2 !== "") {
                tag_array.push(tag_no_2)
            }
            if (tag_no_3 !== "") {
                tag_array.push(tag_no_3)
            }
            const formData = {
                tg_email: tg_email,
                tg_name: tg_name,
                tg_phone: tg_phone,
                tg_organize: tg_organ,
                tg_position: tg_position,
                tag_no: tag_array
            };
            console.log(formData);

            const r = new XMLHttpRequest();
            r.open('POST', 'http://localhost:5000/api/target/regTarget', true);
            r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            r.withCredentials = true;
            r.onreadystatechange = function () {
                let rObj;
                if (r.readyState === 4) {
                    if (r.status === 200) {
                        //document.location.reload();
                        location.reload();
                    } else if (r.status === 400) {
                        alert("등록정보를 입력해주세요. ");
                    } else if (r.status === 402) {
                        alert("이름이나 이메일, 전화번호 입력 형식이 잘못됐습니다. ");
                    } else if (r.status === 403) {
                        if (Verify()) {
                            Refresh();
                            //Note 추후 자기 자신을 다시 호출하도록 개선
                        } else {
                            document.location.href = '/';
                        }
                    } else if (r.status === 405) {
                        alert("훈련대상은 최대 300명 까지만 등록이 가능합니다. ");
                    } else if (r.status === 500) {
                        alert("서버에러");
                    } else {
                        rObj = JSON.parse(r.responseText);
                        alert(rObj.err);
                    }
                }
            };
            r.send(JSON.stringify(formData));
        });
        $('#btn_export').click(function () {
            const tag_no = $('#tag_selector2').val();
            const r = new XMLHttpRequest();
            r.open('GET', 'http://localhost:5000/api/target/exportTarget?tag_no=' + tag_no, true);
            r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            let fileName = null; //if you have the fileName header available
            r.withCredentials = true;
            r.responseType = "blob";
            r.onreadystatechange = function () {
                if (r.readyState === 4) {
                    if (r.status === 200) {
                        const blob = r.response;
                        if (r.getResponseHeader("content-disposition")) {
                            var contentDisposition = r.getResponseHeader("content-disposition");
                            fileName = contentDisposition.substring(contentDisposition.indexOf("=") + 1);
                        } else {
                            fileName = "Registered_Targets.xlsx";
                        }

                        console.log(fileName);
                        const link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = fileName;
                        link.click();
                    } else if (r.status === 403) {
                        if (Verify()) {
                            Refresh();
                            //Note 추후 자기 자신을 다시 호출하도록 개선
                        } else {
                            document.location.href = '/';
                        }
                    }
                }
            };
            //console.log(tag_no);
            r.send();
        });

        $('#excelDownload').click(function () {
            const r = new XMLHttpRequest();
            r.open('GET', 'http://localhost:5000/api/target/downloadExcel', true);
            r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            let fileName = null; //if you have the fileName header available
            r.withCredentials = true;
            r.responseType = "blob"; // 받을 파일의 타입을 blob으로 정의한다.
            r.onreadystatechange = function () {
                if (r.readyState === 4) {
                    if (r.status === 200) {
                        const blob = r.response; //서버에서 받아온 데이터를 여기에 집어넣는다.
                        if (r.getResponseHeader("content-disposition")) {
                            let contentDisposition = r.getResponseHeader("content-disposition");
                            fileName = contentDisposition.substring(contentDisposition.indexOf("=") + 1);
                        } else {
                            fileName = "Target.xlsx";
                        }
                        console.log(fileName);
                        const link = document.createElement('a'); // a라는 html 객체를 생성하고
                        link.href = window.URL.createObjectURL(blob); //그 안에다 다운로드할 파일의 내용을 집어넣는다.
                        link.download = fileName;
                        link.click();
                    } else if (r.status === 403) {
                        if (Verify()) {
                            Refresh();
                            //Note 추후 자기 자신을 다시 호출하도록 개선
                        } else {
                            document.location.href = '/';
                        }
                    }
                }
            };
            r.send();
        });
        $('input[type="file"]').change(function (e) {
            const fileName = e.target.files[0].name;
            $('#uploadFileName').text(fileName);
        });
        $('#excelUpload-btn').click(function () {
            if (confirm('대상자 일괄 등록 시에는\n기 등록된 태그 외에는 태그설정이 되지 않습니다.\n대상자 정보를 보내시겠습니까?')) {
                var data = new FormData();
                data.append("file", $('#file').prop('files')[0]);
                $.ajax({
                    type: "POST",
                    enctype: 'multipart/form-data',
                    url: "http://localhost:5000/api/target/importTargets",
                    data: data,
                    processData: false,
                    contentType: false,
                    async: false,
                    cache: false,
                    timeout: 600000,
                    xhrFields: {
                        withCredentials: true
                    },
                    success: function (result) {
                        console.log("SUCCESS : ", result.data);
                        alert('전송이 완료되었습니다.');
                        location.reload();
                    },
                    error: function (result) {
                        if (result.status === 500) {
                            alert('서버에러');
                        } else if (result.status === 403) {
                            if (Verify()) {
                                Refresh();
                                //Note 추후 자기 자신을 다시 호출하도록 개선
                            } else {
                                document.location.href = '/';
                            }
                        } else if (result.status === 405) {
                            alert("훈련대상은 최대 300명 까지만 등록이 가능합니다. ");
                        } else {
                            alert('파일을 확인해주세요');
                        }
                        console.log("ERROR : ", result.status);
                    }
                });
            }
        });
    });

    function Search(search_division, search_text, page) {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://localhost:5000/api/target/search?search_division=' + search_division +
            '&search_text=' + search_text + '&page=' + page, true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let rObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    rObj = JSON.parse(r.responseText);

                    if (rObj.targets != null) {
                        // table 비워주기
                        $('#targets > tbody').empty();
                        for (let i = 0; i < rObj.targets.length; i++) {
                            // 태그 분리해주는 작업 ..
                            let full_tag = ''
                            for (let j = 0; j < rObj.targets[i].tg_tag.length; j++) {
                                // console.log(rObj.targets[i].tg_tag[j])
                                if (rObj.targets[i].tg_tag[j] !== "") {

                                    if (tg_total[0] === rObj.targets[i].tg_tag[j]) {
                                        full_tag += '<div id="label1" style="">' + rObj.targets[i].tg_tag[j] + '</div>'
                                    } else if (tg_total[1] === rObj.targets[i].tg_tag[j]) {
                                        full_tag += '<div id="label2">' + rObj.targets[i].tg_tag[j] + '</div>'
                                    } else if (tg_total[2] === rObj.targets[i].tg_tag[j]) {
                                        full_tag += '<div id="label3">' + rObj.targets[i].tg_tag[j] + '</div>'
                                    } else if (tg_total[3] === rObj.targets[i].tg_tag[j]) {
                                        full_tag += '<div id="label4">' + rObj.targets[i].tg_tag[j] + '</div>'
                                    } else if (tg_total[4] === rObj.targets[i].tg_tag[j]) {
                                        full_tag += '<div id="label5">' + rObj.targets[i].tg_tag[j] + '</div>'
                                    }
                                }
                            }

                            var phone = "";

                            if (rObj.targets[i].tg_phone.length < 10) {
                                //case : 02-xxx-xxxx
                                phone += rObj.targets[i].tg_phone.substr(0, 2);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(2, 3);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(5, 4);
                            } else if (rObj.targets[i].tg_phone.substr(1, 1) === "2" && rObj.targets[i].tg_phone.length === 10) {
                                //case : 02-xxxx-xxxx
                                phone += rObj.targets[i].tg_phone.substr(0, 2);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(2, 4);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(6, 4);
                            } else if (rObj.targets[i].tg_phone.length === 10) {
                                phone += rObj.targets[i].tg_phone.substr(0, 3);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(3, 3);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(6, 4);
                            } else if (rObj.targets[i].tg_phone.length === 11) {
                                phone += rObj.targets[i].tg_phone.substr(0, 3);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(3, 4);
                                phone += "-"
                                phone += rObj.targets[i].tg_phone.substr(7, 4);
                            }

                            if (full_tag === '') {
                                $('#targets > tbody:last').append('<tr>' + '<td id=' + rObj.targets[i].tg_no +
                                    '" style="visibility:hidden;position:absolute;">' + rObj.targets[i].tg_no + '</td><td><div class="pgn-checkbox"><input type="checkbox" name="">' +
                                    '<span></span></div></td><td>' + rObj.targets[i].fake_no + '</td><td>' +
                                    rObj.targets[i].tg_name + "(" +
                                    rObj.targets[i].tg_email + ")" + '</td><td>' + phone + '</td><td>' + rObj.targets[i].tg_organize +
                                    '</td><td>' + rObj.targets[i].tg_position + '</td><td>' + rObj.targets[i].created_t + '</td>' +
                                    '<td></td></tr>');
                            } else {
                                $('#targets > tbody:last').append('<tr><td id="target_' + rObj.targets[i].tg_no +
                                    '" style="visibility:hidden;position:absolute;">' + rObj.targets[i].tg_no + '</td><td><div class="pgn-checkbox"><input type="checkbox" name="">' +
                                    '<span></span></div></td><td>' + rObj.targets[i].fake_no + '</td><td>' +
                                    rObj.targets[i].tg_name + "(" +
                                    rObj.targets[i].tg_email + ")" + '</td><td>' + phone + '</td><td>' + rObj.targets[i].tg_organize +
                                    '</td><td>' + rObj.targets[i].tg_position + '</td><td>' + rObj.targets[i].created_t + '</td>' +
                                    '<td>' + full_tag + '</td></tr>');
                            }
                        }
                    } else {
                        $('#targets > tbody:last').append('<tr style="background-color:white"><td colspan="10" align="center">' +
                            '<div class="alert alert" style="background-color:white">' +
                            '<p align="center">Info<span style="border: 1px; font-size:15px;' +
                            'font-style: italic; font-weight: 100;">등록된 대상자가 없습니다.</span></p>' +
                            '</div></td></tr>');
                    }

                    search_paging(rObj.total, page);

                } else if (r.status === 403) {
                    if (Verify()) {
                        Refresh();
                        Search(search_division, search_text, page);
                    } else {
                        document.location.href = '/';
                    }
                } else {
                    document.location.href = '/';
                }
            }
        };
        r.send();
    }

    function search_paging(totalData, currentPage) {
        const dataPerPage = 20;
        const pageCount = 5;

        console.log("currentPage : " + currentPage);
        console.log("totalData : " + totalData);
        const totalPage = Math.ceil(totalData / dataPerPage);    // 총 페이지 수
        const pageGroup = Math.ceil(currentPage / pageCount);    // 페이지 그룹

        console.log("pageGroup : " + pageGroup);
        console.log("totalPage : " + totalPage);

        let last = pageGroup * pageCount;    // 화면에 보여질 마지막 페이지 번호

        if (last > totalPage)
            last = totalPage;
        let first = last - (pageCount - 1);    // 화면에 보여질 첫번째 페이지 번호
        const next = last + 1;
        const prev = first - 1;

        console.log("last : " + last);
        console.log("first : " + first);
        console.log("next : " + next);
        console.log("prev : " + prev);

        const division = $('#search_division').val();
        const text = $('#search_text').val();

        console.log(text);

        if (totalPage < 1) {
            first = last;
        }

        //Search(division, text, 1);

        const pages = $("#pages");
        pages.empty();
        if (first > 5) {

            var li = document.createElement('li');
            li.className = 'pagination-item';

            var element = document.createElement('a');
            element.className = 'active';
            element.addEventListener('click', function () {
                Search(division, text, prev);
            }, false);
            element.style.marginLeft = 2 + "px";
            element.innerHTML = prev;

            li.appendChild(element);
            pages.append(li);
        }
        for (let j = first; j <= last; j++) {
            if (currentPage === (j)) {
                var li = document.createElement('li');
                li.className = 'pagination-item';

                var element = document.createElement('a');
                element.className = 'active';
                element.addEventListener('click', function () {
                    Search(division, text, j);
                }, false);
                element.style.marginLeft = 2 + "px";
                element.innerHTML = j;

                li.appendChild(element);
                pages.append(li);
            } else if (j > 0) {
                var li = document.createElement('li');
                li.className = 'pagination-item';

                var element = document.createElement('a');
                element.addEventListener('click', function () {
                    Search(division, text, j);
                }, false);
                element.style.marginLeft = 2 + "px";
                element.innerHTML = j;

                li.appendChild(element);
                pages.append(li);
            }
        }
        if (next > 5 && next < totalPage) {
            var li = document.createElement('li');
            li.className = 'pagination-item';

            var element = document.createElement('a');
            element.className = 'active';
            element.addEventListener('click', function () {
                Search(division, text, next);
            }, false);
            element.style.marginLeft = 2 + "px";
            element.innerHTML = next;

            li.appendChild(element);
            pages.append(li);
        }
    }


    function inputPhoneNumber(obj) {

        let number = obj.value.replace(/[^0-9]/g, "");
        let phone = "";

        if (number.length < 4) {
            return number;
        } else if (number.length < 7) {
            phone += number.substr(0, 3);
            phone += "-";
            phone += number.substr(3);
        } else if (number.substr(1, 1) === "2" && number.length < 10) {
            //case 02-xxx-xxxx
            phone += number.substr(0, 2);
            phone += "-";
            phone += number.substr(2, 3);
            phone += "-";
            phone += number.substr(5, 4);
        } else if (number.substr(1, 1) === "2" && number.length < 11) {
            phone += number.substr(0, 2);
            phone += "-";
            phone += number.substr(2, 4);
            phone += "-";
            phone += number.substr(6, 4);
        } else if (number.length < 11) {
            //case 010-xxx-xxxx, 031-xxx-xxxx
            phone += number.substr(0, 3);
            phone += "-";
            phone += number.substr(3, 3);
            phone += "-";
            phone += number.substr(6);
        } else { //010-xxxx-xxxx, 031-xxxx-xxxx
            phone += number.substr(0, 3);
            phone += "-";
            phone += number.substr(3, 4);
            phone += "-";
            phone += number.substr(7);
        }
        obj.value = phone;
    }

    $("#search_text").keypress(function (e) {
        if (e.keyCode === 13) {
            const division = $('#search_division').val();
            const text = $('#search_text').val();
            if (!text) {
                $('#search_text').focus();
                alert("검색어를 입력하세요.");
                return false;
            } else {
                // $('#targets').empty();
                // $('#tag_menage').empty();
                $('#targets > tbody ').empty();
                $('#tag_menage > tbody').empty();
                Search(division, text, 1);
                return false;
            }
        }
    });

    $("#search_button").click(function search_click() {
        const division = $('#search_division').val();
        const text = $('#search_text').val();
        if (!text) {
            $('#search_text').focus();
            alert("검색어를 입력하세요.");
            return false;
        } else {
            // $('#targets').empty();
            // $('#tag_menage').empty();
            $('#targets > tbody ').empty();
            $('#tag_menage > tbody').empty();
            Search(division, text, 1);
            return false;
        }
    });

    // 비동기 순차처리
    getTagForTargetInfo();
    // setTimeout(function () {
    //     GetTarget(1);
    // },170)
    GetTarget(1);
    GetDashBoard();

</script>
</body>

</html>
